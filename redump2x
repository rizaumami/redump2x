#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# LICENSE ----------------------------------------------------------------------
#
# This is free and unencumbered software released into the public domain.
#
# Anyone is free to copy, modify, publish, use, compile, sell, or
# distribute this software, either in source code form or as a compiled
# binary, for any purpose, commercial or non-commercial, and by any
# means.
#
# In jurisdictions that recognize copyright laws, the author or authors
# of this software dedicate any and all copyright interest in the
# software to the public domain. We make this dedication for the benefit
# of the public at large and to the detriment of our heirs and
# successors. We intend this dedication to be an overt act of
# relinquishment in perpetuity of all present and future rights to this
# software under copyright law.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.
#
# For more information, please refer to <http://unlicense.org>
#
# ------------------------------------------------------------------------------

# TODO:
# - Patch game and game save thumbnail
# - Use a different xbe id/disc version so title updates dont load from attacher but do load on the game iso xbe.
# - CISO support

# Get the current working directory.
HERE=$(dirname "$(readlink -f "${0}")")

# Checking dependencies:
# 1.  xdvdfs: https://github.com/antangelo/xdvdfs
# 2.  7z, grep, xxd
#     sudo apt install p7zip-full grep xxd
# 3.  attach.xbe
#     Get it from driveimageutils-v1.0.1 package from "the usual place".
declare -a DEPS=(7z 'attach.xbe' dd grep xdvdfs xxd)
for ((NUM=${#DEPS[@]},i=0; i<NUM;i++)); do
  if command -v "${DEPS[i]}" &>/dev/null || [[ -f $HERE/bin/${DEPS[i]} ]]; then
    unset -v 'DEPS[i]'
  fi
done

# Exit if dependency not found.
if [[ "${#DEPS[@]}" -gt 0 ]]; then
  printf '\e[31m!! %s\n\e[m' 'Package(s) not found'
  printf '   - %s\n' "${DEPS[@]}"
  exit 1
fi

# VARIABLES --------------------------------------------------------------------

ARTWORKS="$HERE/bin/artworks.7z"
# Launching xiso from ogxbox's disk need virtual disc attacher.
ATTACH=false
# It should be in $HOME/.cargo/bin/xdvdfs if installed from Cargo.
EXISO="$HERE/bin/xdvdfs"
# Where to look for input and output. Default to user's home directory.
INPUT="$HOME"
OUTPUT="$HOME"
# Split the output file.
SPLIT=0
# Script will extract input archive into this temporary directory.
# Pay attention if you mount tmpfs on /tmp.
TMPDIR=$(mktemp -d)
# Update attach.xbe, game cover, filename, and directory name.
UPDATE=false

# FUNCTIONS --------------------------------------------------------------------

add_artworks() {
  # Artwork for UnleashX dashboard.
  if [[ -f $ARTWORKS ]]; then
    mapfile -t ICON < <(7z l -slt "$ARTWORKS" | grep -oP "(?<=Path = ${1}).*?(?=$)")
    if [[ ${#ICON[@]} -eq 0 ]]; then
      print_w 'No artwork found.'
    else
      #printf '\r:: %s\n' 'Copying artwork.                '
      7z e "$ARTWORKS" "${1}${ICON[0]}" -so > "$2/Icon.jpg"
    fi
  else
    printf '\r\e[33m:: %s\n\e[m' 'Artwork is missing. Please install it first.'
  fi
}

get_title() {
  declare -A TITLENAME=(
    ["55530036"]="187 Ride or Die"
    ["4541000B"]="2002 FIFA World Cup"
    ["4541009C"]="2006 FIFA World Cup"
    ["45530018"]="25 to Life"
    ["54540001"]="4x4 Evo 2"
    ["56550042"]="50 Cent: Bulletproof"
    ["4D4A0009"]="Advent Rising"
    ["4D4A0014"]="Æon Flux"
    ["4143000D"]="AFL Live 2003"
    ["4143001B"]="AFL Live 2004"
    ["41430023"]="AFL Live Premiership Edition"
    ["54510101"]="AFL Premiership"
    ["41430007"]="Aggressive Inline"
    ["4B4E0002"]="AirForce Delta Storm"
    ["41430016"]="Alias"
    ["5A440004"]="Alien Hominid"
    ["56550022"]="Aliens Versus Predator: Extinction"
    ["41430002"]="All-Star Baseball 2003"
    ["41430018"]="All-Star Baseball 2004"
    ["4143001C"]="All-Star Baseball 2005"
    ["5451000F"]="Alter Echo"
    ["55530043"]="America's Army: Rise of a Soldier"
    ["4156003D"]="American Chopper"
    ["4156004F"]="American Chopper 2: Full Throttle"
    ["454C0001"]="American McGee Presents: Scrapland"
    ["42530009"]="AMF Bowling 2004"
    ["42530014"]="AMF Xtreme Bowling"
    ["4D530041"]="Amped 2"
    ["4D530005"]="Amped: Freestyle Snowboarding"
    ["55530056"]="AND 1 Streetball"
    ["53550007"]="Angelic Concert (JP)"
    ["494F0003"]="Animaniacs: The Great Edgar Hunt"
    ["56550009"]="Antz Extreme Racing"
    ["494C0006"]="Aoi Namida (JP)"
    ["49470015"]="APEX"
    ["544D0003"]="Aquaman: Battle for Atlantis"
    ["4D570002"]="Arctic Thunder"
    ["4D570005"]="Area 51"
    ["45410094"]="Arena Football"
    ["4C41000D"]="Armed and Dangerous"
    ["54540088"]="Army Men: Major Malfunction"
    ["54540014"]="Army Men: Sarge's War"
    ["44430002"]="Arx Fatalis"
    ["49470079"]="Atari Anthology"
    ["4143000A"]="ATV Quad Power Racing 2"
    ["4343000E"]="Auto Modellista"
    ["54510105"]="Avatar: The Last Airbender"
    ["4D530007"]="Azurik: Rise of Perathia"
    ["45530016"]="Backyard Wrestling 2: There Goes the Neighborhood"
    ["4553000D"]="Backyard Wrestling: Don't Try This at Home"
    ["454D0008"]="Bad Boys II"
    ["454D0016"]="Bad Boys: Miami Takedown"
    ["5655001A"]="Baldur's Gate: Dark Alliance"
    ["4950000A"]="Baldur's Gate: Dark Alliance II"
    ["54530002"]="Barbarian"
    ["5655002A"]="Barbie Horse Adventures: Wild Horse Rescue"
    ["56550048"]="Bass Pro Shops Trophy Hunter 2007"
    ["56550049"]="Bass Pro Shops: Trophy Bass 2007"
    ["45410389"]="Batman Begins"
    ["4B420001"]="Batman: Dark Tomorrow"
    ["5553001C"]="Batman: Rise of Sin Tzu"
    ["55530001"]="Batman: Vengeance"
    ["49470010"]="Battle Engine Aquila"
    ["45410062"]="Battlefield 2: Modern Combat"
    ["5655000F"]="Battlestar Galactica"
    ["43430015"]="Beat Down: Fists of Vengeance"
    ["55530018"]="Beyond Good & Evil"
    ["41560040"]="Bicycle Casino"
    ["4D5300D2"]="Big Bumpin'"
    ["454D0002"]="Big Mutha Truckers"
    ["454D0017"]="Big Mutha Truckers 2"
    ["45410039"]="Bionicle"
    ["53550001"]="Bistro Cupid (JP)"
    ["53550008"]="Bistro Cupid 2"
    ["45410083"]="Black"
    ["58490004"]="Black Stone: Magic & Steel"
    ["41560005"]="Blade II"
    ["55530057"]="Blazing Angels: Squadrons of WWII"
    ["4D530065"]="Blinx 2: Masters of Time and Space"
    ["4D530013"]="Blinx: The Time Sweeper"
    ["4D570026"]="Blitz: The League"
    ["45530006"]="Blood Omen 2"
    ["4D530010"]="Blood Wake"
    ["4D4A0001"]="BloodRayne"
    ["4D4A000D"]="BloodRayne 2"
    ["48550001"]="Bloody Roar Extreme"
    ["4D4A0008"]="BlowOut"
    ["4143000E"]="BMX XXX"
    ["494C0002"]="Braveknight"
    ["41530001"]="Break Nine: World Billiards Tournament"
    ["4E4D0009"]="Breakdown"
    ["42530012"]="Breeders' Cup World Thoroughbred Championships"
    ["434D004E"]="Brian Lara International Cricket 2005"
    ["5451001D"]="Broken Sword: The Sleeping Dragon"
    ["5553005A"]="Brothers in Arms: Earned in Blood"
    ["5553003C"]="Brothers in Arms: Road to Hill 30"
    ["56550016"]="Bruce Lee: Quest of the Dragon"
    ["4D53001E"]="Brute Force"
    ["45410012"]="Buffy the Vampire Slayer"
    ["56550005"]="Buffy the Vampire Slayer: Chaos Bleeds"
    ["41430006"]="Burnout"
    ["41430019"]="Burnout 2: Point of Impact"
    ["4541005B"]="Burnout 3: Takedown"
    ["45410076"]="Burnout Revenge"
    ["4D450001"]="C.A.T.: Cyber Attack Team"
    ["4156003E"]="Cabela's Big Game Hunter 2005 Adventures"
    ["41560019"]="Cabela's Dangerous Hunts"
    ["41560052"]="Cabela's Dangerous Hunts 2"
    ["41560030"]="Cabela's Deer Hunt: 2004 Season"
    ["4156003F"]="Cabela's Deer Hunt: 2005 Season"
    ["4156004D"]="Cabela's Outdoor Adventures"
    ["42530007"]="Call of Cthulhu: Dark Corners of the Earth"
    ["41560051"]="Call of Duty 2: Big Red One"
    ["4156005D"]="Call of Duty 3"
    ["4156002A"]="Call of Duty: Finest Hour"
    ["43430018"]="Capcom Classics Collection Vol. 1"
    ["43430019"]="Capcom Classics Collection Vol. 2"
    ["43430010"]="Capcom Fighting Evolution"
    ["43430008"]="Capcom vs. SNK 2 EO"
    ["424D0006"]="Carmen Sandiego: The Secret of the Stolen Drums"
    ["545100F2"]="Cars"
    ["54540010"]="Carve"
    ["4B4E002D"]="Castlevania: Curse of Darkness"
    ["4541005C"]="Catwoman"
    ["45410011"]="Cel Damage"
    ["5454000B"]="Celebrity Deathmatch"
    ["584D0003"]="Championship Bowling"
    ["53430100"]="Championship Manager 2006"
    ["4553001A"]="Championship Manager 5"
    ["45530002"]="Championship Manager: Season 01/02"
    ["4553000C"]="Championship Manager: Season 02/03"
    ["54540081"]="Charlie and the Chocolate Factory"
    ["424D0001"]="Chase: Hollywood Stunt Driver"
    ["55530039"]="Chessmaster"
    ["4B420005"]="Chicago Enforcer"
    ["42560002"]="Chicken Little"
    ["45430001"]="Circus Maximus: Chariot Wars"
    ["5454007D"]="Classified: The Sentinel Crisis"
    ["54540012"]="Close Combat: First to Fight"
    ["434D000C"]="Club Football - AC Milan"
    ["434D0012"]="Club Football - Ajax Amsterdam"
    ["434D0013"]="Club Football - Arsenal"
    ["434D0014"]="Club Football - Aston Villa"
    ["434D0017"]="Club Football - Borussia Dortmund"
    ["434D0018"]="Club Football - Celtic FC"
    ["434D0019"]="Club Football - Chelsea FC"
    ["434D0015"]="Club Football - FC Barcelona"
    ["434D0016"]="Club Football - FC Bayern Muenchen"
    ["434D001B"]="Club Football - FC Internazionale"
    ["434D0023"]="Club Football - Hamburger Sv"
    ["434D001C"]="Club Football - Juventus"
    ["434D001D"]="Club Football - Leeds United"
    ["434D001E"]="Club Football - Liverpool FC"
    ["434D0020"]="Club Football - Manchester United"
    ["434D0021"]="Club Football - Rangers FC"
    ["434D0022"]="Club Football - Real Madrid"
    ["434D003A"]="Club Football 2005 - AC Milan"
    ["434D0039"]="Club Football 2005 - AFC Ajax"
    ["434D0031"]="Club Football 2005 - Arsenal"
    ["434D0033"]="Club Football 2005 - Aston Villa"
    ["434D0041"]="Club Football 2005 - Birmingham"
    ["434D003F"]="Club Football 2005 - Bvb"
    ["434D0035"]="Club Football 2005 - Celtic FC"
    ["434D0032"]="Club Football 2005 - Chelsea FC"
    ["434D0038"]="Club Football 2005 - FC Barcelona"
    ["434D003E"]="Club Football 2005 - FC Bayern"
    ["434D003B"]="Club Football 2005 - FC Inter"
    ["434D003D"]="Club Football 2005 - Hamburger Sv"
    ["434D003C"]="Club Football 2005 - Juventus"
    ["434D0030"]="Club Football 2005 - Liverpool FC"
    ["434D002F"]="Club Football 2005 - Man Utd"
    ["434D0044"]="Club Football 2005 - Marseille"
    ["434D0040"]="Club Football 2005 - Newcastle Utd"
    ["434D0043"]="Club Football 2005 - PSG"
    ["434D0036"]="Club Football 2005 - Rangers FC"
    ["434D0037"]="Club Football 2005 - Real Madrid"
    ["434D0042"]="Club Football 2005 - Tottenham"
    ["5454008A"]="Codename: Kids Next Door - Operation: V.I.D.E.O.G.A.M.E."
    ["5553004B"]="Cold Fear"
    ["44430004"]="Cold War"
    ["434D0010"]="Colin McRae Rally 04"
    ["434D002B"]="Colin McRae Rally 2005"
    ["434D0001"]="Colin McRae Rally 3"
    ["54540091"]="College Hoops 2K6"
    ["545400AF"]="College Hoops 2K7"
    ["53500001"]="Combat Elite: WWII Paratroopers"
    ["47560003"]="Combat: Task Force 121"
    ["45530008"]="Commandos 2: Men of Courage"
    ["534300F9"]="Commandos: Strike Force"
    ["544D0008"]="Conan"
    ["54540005"]="Conflict: Desert Storm"
    ["53430006"]="Conflict: Desert Storm II: Back to Baghdad"
    ["5343000C"]="Conflict: Global Terror"
    ["5343000A"]="Conflict: Vietnam"
    ["4D530051"]="Conker: Live & Reloaded"
    ["4F580001"]="Conspiracy: Weapons of Mass Destruction"
    ["5343000F"]="Constantine"
    ["544D000B"]="Corvette"
    ["48500002"]="Counter Terrorist Special Forces: Fire for Effect"
    ["4D530036"]="Counter-Strike"
    ["52410006"]="Crash"
    ["45530014"]="Crash 'n' Burn"
    ["56550003"]="Crash Bandicoot: The Wrath of Cortex"
    ["5655001F"]="Crash Nitro Kart"
    ["56550041"]="Crash Tag Team Racing"
    ["56550036"]="Crash Twinsanity"
    ["53450004"]="Crazy Taxi 3: High Roller"
    ["45410074"]="Cricket 2005"
    ["4B4E001C"]="Crime Life: Gang Wars"
    ["4B4F0002"]="Crimson Sea"
    ["4D530021"]="Crimson Skies: High Road to Revenge"
    ["55530020"]="Crouching Tiger, Hidden Dragon"
    ["464C0002"]="Crusty Demons"
    ["5553003F"]="CSI: Crime Scene Investigation"
    ["4E4D0019"]="Curious George"
    ["57450005"]="Curse: The Eye of Isis"
    ["58500001"]="Daemon Vector[b]"
    ["434B0001"]="Dai Senryaku VII: Modern Military Tactics"
    ["41430017"]="Dakar 2: The World's Ultimate Rally"
    ["4B4E0019"]="Dance Dance Revolution Ultramix"
    ["4B4E0021"]="Dance Dance Revolution Ultramix 2"
    ["4B4E0029"]="Dance Dance Revolution Ultramix 3"
    ["4B4E0037"]="Dance Dance Revolution Ultramix 4"
    ["42420002"]="Dance: UK"
    ["4B4E001D"]="Dancing Stage Unleashed"
    ["54510004"]="Dark Summit"
    ["43430016"]="Darkwatch"
    ["41430001"]="Dave Mirra Freestyle BMX 2"
    ["52410003"]="David Beckham Soccer"
    ["49470027"]="Dead Man's Hand"
    ["54430001"]="Dead or Alive 3"
    ["54430006"]="Dead or Alive Ultimate"
    ["54430007"]="Dead or Alive Xtreme Beach Volleyball"
    ["4E4D0005"]="Dead to Rights"
    ["4E4D0015"]="Dead to Rights II"
    ["55530004"]="Deathrow"
    ["45410049"]="Def Jam: Fight for NY"
    ["4D570006"]="Defender"
    ["4E4C0002"]="Delta Force: Black Hawk Down"
    ["4D440003"]="Dennou Taisen: DroneZ"
    ["54510026"]="Destroy All Humans!"
    ["54510106"]="Destroy All Humans! 2"
    ["45530005"]="Deus Ex: Invisible War"
    ["56560029"]="Die Hard: Vendetta"
    ["42410001"]="Digimon Rumble Arena 2"
    ["42410002"]="Digimon World 4"
    ["43430003"]="Dino Crisis 3"
    ["4D530069"]="Dinosaur Hunting"
    ["544D000F"]="Dinotopia: The Sunstone Odyssey"
    ["41560027"]="Disney's Extreme Skate Adventure"
    ["4156004E"]="Doom 3"
    ["41560020"]="Doom 3: Resurrection of Evil"
    ["42550004"]="Double-S.T.E.A.L. - The Second Clash"
    ["42550001"]="Double-STEAL"
    ["4D570011"]="Dr. Muto"
    ["56550028"]="Dr. Seuss' The Cat in the Hat"
    ["4947007A"]="Dragon Ball Z: Sagas"
    ["55530012"]="Dragon's Lair 3D: Return to the Lair"
    ["4D4A000B"]="Drake of the 99 Dragons"
    ["41590004"]="Dreamfall: The Longest Journey"
    ["48570001"]="Drihoo (JP)"
    ["49470038"]="DRIV3R"
    ["4947007F"]="Driver: Parallel Lines"
    ["49470013"]="Dungeons & Dragons: Heroes"
    ["4B4F0003"]="Dynasty Warriors 3"
    ["4B4F0004"]="Dynasty Warriors 4"
    ["4B4F0007"]="Dynasty Warriors 5"
    ["4D570032"]="Ed, Edd n Eddy: The Mis-Edventures"
    ["4B420002"]="Egg Mania: Eggstreme Madness"
    ["5655000E"]="Enclave"
    ["434D0028"]="England International Football"
    ["49470022"]="Enter the Matrix"
    ["56550043"]="Eragon"
    ["53450024"]="ESPN College Hoops"
    ["53450033"]="ESPN College Hoops 2K5"
    ["4B4E000B"]="ESPN International Winter Sports 2002"
    ["53450028"]="ESPN Major League Baseball"
    ["4B4E0005"]="ESPN MLS ExtraTime 2002"
    ["53450031"]="ESPN NBA 2K5"
    ["4B4E0006"]="ESPN NBA 2Night 2002"
    ["53450023"]="ESPN NBA Basketball"
    ["53450030"]="ESPN NFL 2K5"
    ["53450022"]="ESPN NFL Football"
    ["4B4E0003"]="ESPN NFL PrimeTime 2002"
    ["53450032"]="ESPN NHL 2K5"
    ["53450026"]="ESPN NHL Hockey"
    ["4B4E0009"]="ESPN Winter X-Games Snowboarding 2002"
    ["5451000B"]="Evil Dead: A Fistful of Boomstick"
    ["54510025"]="Evil Dead: Regeneration"
    ["49460001"]="Ex-Chaser"
    ["4B4B0003"]="ExaSkeleton"
    ["45410007"]="F1 2001"
    ["45410014"]="F1 2002"
    ["45410032"]="F1 Career Challenge"
    ["4D53000D"]="Fable"
    ["4D5300D1"]="Fable: The Lost Chapters"
    ["49500008"]="Fallout: Brotherhood of Steel"
    ["545400B0"]="Family Guy Video Game!"
    ["4156001A"]="Fantastic 4"
    ["55530008"]="Far Cry Instincts"
    ["55530060"]="Far Cry Instincts: Evolution"
    ["54430004"]="Fatal Frame"
    ["5443000A"]="Fatal Frame II: Crimson Butterfly"
    ["45410078"]="FIFA 06"
    ["454100A6"]="FIFA 07"
    ["45410017"]="FIFA Football 2003"
    ["4541003B"]="FIFA Football 2004"
    ["4541004E"]="FIFA Football 2005"
    ["45410072"]="FIFA Street"
    ["45410085"]="FIFA Street 2"
    ["5655002F"]="Fight Club"
    ["4541004B"]="Fight Night 2004"
    ["45410055"]="Fight Night Round 2"
    ["45410086"]="Fight Night: Round 3"
    ["54510009"]="FILA World Tour Tennis"
    ["43430013"]="Final Fight: Streetwise"
    ["5451001E"]="Finding Nemo"
    ["4D570012"]="Fire Blade"
    ["454D0009"]="FlatOut"
    ["454D0020"]="FlatOut 2"
    ["41510002"]="Flight Academy"
    ["454D001F"]="Ford Bold Moves Street Racing"
    ["54540077"]="Ford Mustang: The Legend Lives"
    ["454D0007"]="Ford Racing 2"
    ["454D000D"]="Ford Racing 3"
    ["54540089"]="Ford vs. Chevy"
    ["49470074"]="Forgotten Realms: Demon Stone"
    ["4D53006E"]="Forza Motorsport"
    ["48450004"]="Frankie Dettori Racing"
    ["4D570007"]="Freaky Flyers"
    ["4541002E"]="Freedom Fighters"
    ["4D570017"]="Freestyle MetalX"
    ["4B4E0013"]="Frogger Beyond"
    ["4B4E002C"]="Frogger: Ancient Shadow"
    ["54510022"]="Full Spectrum Warrior"
    ["545100F8"]="Full Spectrum Warrior: Ten Hammers"
    ["4947000B"]="Furious Karting"
    ["56550008"]="Futurama"
    ["43560007"]="Future Tactics: The Uprising"
    ["4D530002"]="Fuzion Frenzy"
    ["42520001"]="Galaxy Angel"
    ["41540004"]="Galleon"
    ["4D57000E"]="Gauntlet Dark Legacy"
    ["4D570022"]="Gauntlet: Seven Sorrows"
    ["544D0011"]="Gene Troopers"
    ["43430001"]="Genma Onimusha"
    ["454D0004"]="Ghost Master: The Gravenville Chronicles"
    ["4143001A"]="Gladiator: Sword of Vengeance"
    ["4C410008"]="Gladius"
    ["4A410005"]="Goblin Commander: Unleash the Horde"
    ["49470039"]="Godzilla: Destroy All Monsters Melee"
    ["49470073"]="Godzilla: Save the Earth"
    ["4541005D"]="GoldenEye: Rogue Agent"
    ["5454007E"]="Gotcha!"
    ["4D530053"]="Grabbed by the Ghoulies"
    ["5454000E"]="Grand Theft Auto III"
    ["54540082"]="Grand Theft Auto: San Andreas"
    ["54540073"]="Grand Theft Auto: Vice City"
    ["4D57000D"]="Gravity Games Bike: Street. Vert. Dirt."
    ["41560042"]="Greg Hastings Tournament Paintball"
    ["41560057"]="Greg Hastings' Tournament Paintball Max'd"
    ["45430002"]="Grooverider: Slot Car Thunder"
    ["43430005"]="Group S Challenge"
    ["41570001"]="Guilty Gear Isuka[1]"
    ["53410002"]="Guilty Gear X2#Reload[2]"
    ["4156004B"]="Gun"
    ["4D4A0003"]="Gun Metal"
    ["54430009"]="GunGriffon: Allied Strike"
    ["5345000B"]="Gunvalkyrie"
    ["45410091"]="Half-Life 2"
    ["4D530064"]="Halo 2"
    ["4D5380CD"]="Halo 2 Multiplayer Map Pack"
    ["4D530004"]="Halo: Combat Evolved"
    ["4541000E"]="Harry Potter and the Chamber of Secrets"
    ["45410077"]="Harry Potter and the Goblet of Fire"
    ["4541004C"]="Harry Potter and the Prisoner of Azkaban"
    ["45410037"]="Harry Potter and the Sorcerer's Stone"
    ["4541003D"]="Harry Potter: Quidditch World Cup"
    ["53450025"]="Headhunter Redemption"
    ["58500004"]="Hello Kitty: Roller Rescue"
    ["45430004"]="Heroes of the Pacific"
    ["54440006"]="High Heat Major League Baseball 2004"
    ["4253000F"]="High Rollers Casino"
    ["45530009"]="Hitman 2: Silent Assassin"
    ["534300FA"]="Hitman: Blood Money"
    ["45530012"]="Hitman: Contracts"
    ["54510089"]="Hot Wheels: Stunt Track Challenge"
    ["56550011"]="Hulk"
    ["5454009C"]="Hummer Badlands"
    ["56550007"]="Hunter: The Reckoning"
    ["5655002D"]="Hunter: The Reckoning: Redeemer"
    ["4B4E000A"]="Hyper Sports 2002 Winter"
    ["4E4D000F"]="I-Ninja"
    ["5655004B"]="Ice Age 2: The Meltdown"
    ["42530006"]="IHRA Drag Racing 2004"
    ["42530011"]="IHRA Drag Racing: Sportsman Edition"
    ["4253000C"]="IHRA Professional Drag Racing 2005"
    ["4C410007"]="Indiana Jones and the Emperor's Tomb"
    ["4947007B"]="Indigo Prophecy"
    ["434D0006"]="IndyCar Series"
    ["434D0024"]="IndyCar Series 2005"
    ["4B550001"]="Innocent Tears"
    ["4D530034"]="Inside Pitch 2003"
    ["43560006"]="Intellivision Lives!"
    ["4B4E0008"]="International Superstar Soccer 2"
    ["53410003"]="Iron Phoenix"
    ["454D001E"]="Jacked"
    ["4D53006D"]="Jade Empire"
    ["4541000D"]="James Bond 007: Agent Under Fire"
    ["45410042"]="James Bond 007: Everything or Nothing"
    ["45410079"]="James Bond 007: From Russia with Love"
    ["45410026"]="James Bond 007: Nightfire"
    ["56550014"]="James Cameron's Dark Angel"
    ["4D4A000F"]="Jaws Unleashed"
    ["5345000A"]="Jet Set Radio Future"
    ["4B410001"]="Jikkyou World Soccer 2002"
    ["4D530030"]="Jockey's Road"
    ["58490007"]="Judge Dredd: Dredd Vs. Death"
    ["545100EF"]="Juiced"
    ["56550021"]="Jurassic Park: Operation Genesis"
    ["534300FB"]="Just Cause"
    ["57520001"]="Justice League Heroes"
    ["43560001"]="Kabuki Warriors"
    ["4D53000C"]="Kakuto Chojin"
    ["4A570003"]="Kao the Kangaroo: Round 2"
    ["4B4E0025"]="Karaoke Revolution"
    ["4B4E002E"]="Karaoke Revolution Party"
    ["41560002"]="Kelly Slater's Pro Surfer"
    ["54410001"]="Kikou Heidan J-Phoenix +"
    ["4E4D000B"]="Kill Switch"
    ["4B4E0024"]="King Arthur"
    ["504C0006"]="Kingdom Under Fire: Heroes"
    ["504C0002"]="Kingdom Under Fire: The Crusaders"
    ["4D490004"]="Knight's Apprentice: Memorick's Adventures"
    ["544D0013"]="Knights of the Temple II"
    ["544D0007"]="Knights of the Temple: Infernal Crusade"
    ["4541000A"]="Knockout Kings 2002"
    ["4D530031"]="Kung Fu Chaos"
    ["4D570025"]="L.A. Rush"
    ["47560004"]="Land of the Dead: Road to Fiddler's Green"
    ["5553000B"]="Largo Winch: Empire Under Threat"
    ["4553000F"]="Legacy of Kain: Defiance"
    ["41430003"]="Legends of Wrestling"
    ["4143000F"]="Legends of Wrestling II"
    ["4C41001F"]="Lego Star Wars II: The Original Trilogy"
    ["4553001D"]="Lego Star Wars: The Video Game"
    ["56550031"]="Leisure Suit Larry: Magna Cum Laude"
    ["4156001F"]="Lemony Snicket's A Series of Unfortunate Events"
    ["4D53005D"]="Links 2004"
    ["434D0004"]="LMA Manager 2003"
    ["434D000F"]="LMA Manager 2004"
    ["434D0046"]="LMA Manager 2005"
    ["434D0054"]="LMA Manager 2006"
    ["49470006"]="Loons: The Fight for Fame"
    ["58490005"]="Lotus Challenge"
    ["56550018"]="Mace Griffin: Bounty Hunter"
    ["45530001"]="Mad Dash Racing"
    ["4156003B"]="Madagascar"
    ["45410075"]="Madden NFL 06"
    ["4541009F"]="Madden NFL 07"
    ["454100AC"]="Madden NFL 08"
    ["4541023B"]="Madden NFL 09"
    ["45410001"]="Madden NFL 2002"
    ["45410019"]="Madden NFL 2003"
    ["45410036"]="Madden NFL 2004"
    ["4541004D"]="Madden NFL 2005"
    ["54540009"]="Mafia"
    ["4D530066"]="Magatama"
    ["544B0001"]="Magi Death Fight: Mahou Gakuen"
    ["4947000E"]="Magic the Gathering: Battlegrounds"
    ["53450037"]="Major League Baseball 2K5"
    ["54540096"]="Major League Baseball 2K5: World Series Edition"
    ["54540092"]="Major League Baseball 2K6"
    ["545400B1"]="Major League Baseball 2K7"
    ["4253000A"]="Malice"
    ["434D0049"]="Manchester United Manager 2005"
    ["54540019"]="Manhunt"
    ["4947007D"]="Marc Ecko's Getting Up: Contents Under Pressure"
    ["4541038A"]="Marvel Nemesis: Rise of the Imperfects"
    ["43430007"]="Marvel vs. Capcom 2"
    ["4156005C"]="Marvel: Ultimate Alliance"
    ["454D000A"]="Mashed: Drive to Survive"
    ["454D001B"]="Mashed: Fully Loaded"
    ["4156000B"]="Mat Hoffman's Pro BMX 2"
    ["54540003"]="Max Payne"
    ["5454000C"]="Max Payne 2: The Fall of Max Payne"
    ["4D53002E"]="Maximum Chase"
    ["4D530017"]="MechAssault"
    ["4D53006B"]="MechAssault 2: Lone Wolf"
    ["4541005E"]="Medal of Honor: European Assault"
    ["4541001A"]="Medal of Honor: Frontline"
    ["4541003F"]="Medal of Honor: Rising Sun"
    ["43430011"]="Mega Man Anniversary Collection"
    ["56550019"]="Men of Valor"
    ["4C410015"]="Mercenaries: Playground of Destruction"
    ["5655000A"]="Metal Arms: Glitch in the System"
    ["58490001"]="Metal Dungeon"
    ["4B4E0007"]="Metal Gear Solid 2: Substance"
    ["534E0002"]="Metal Slug 3"
    ["53400000"]="Metal Slug 4"
    ["534E0008"]="Metal Slug 5"
    ["46530006"]="Metal Wolf Chaos"
    ["44580001"]="Miami Vice"
    ["4947001C"]="Micro Machines"
    ["54540079"]="Midnight Club 3: DUB Edition"
    ["54540008"]="Midnight Club II"
    ["4D53002A"]="Midtown Madness 3"
    ["4D57001C"]="Midway Arcade Treasures"
    ["4D570020"]="Midway Arcade Treasures 2"
    ["4D57002D"]="Midway Arcade Treasures 3"
    ["434D0003"]="Mike Tyson Heavyweight Boxing"
    ["41560014"]="Minority Report: Everybody Runs"
    ["4947001F"]="Mission Impossible: Operation Surma"
    ["4D570008"]="MLB Slugfest 2003"
    ["4D570009"]="MLB Slugfest 2004"
    ["4D570038"]="MLB Slugfest 2006"
    ["4D57001D"]="MLB Slugfest: Loaded"
    ["43560005"]="Mojo!"
    ["4947000F"]="Monopoly Party"
    ["55530049"]="Monster 4x4: World Circuit"
    ["41560041"]="Monster Garage"
    ["4D570034"]="Mortal Kombat: Armageddon"
    ["4D57000C"]="Mortal Kombat: Deadly Alliance"
    ["4D570019"]="Mortal Kombat: Deception"
    ["4D570029"]="Mortal Kombat: Shaolin Monks"
    ["54540015"]="Motocross Mania 3"
    ["54510008"]="MotoGP"
    ["54510016"]="MotoGP 2"
    ["54510088"]="MotoGP 3"
    ["434D0029"]="MTV Music Generator 3: This is the Remix"
    ["41560022"]="MTX: Mototrax"
    ["55530016"]="Murakumo: Renegade Mech Pursuit"
    ["56430001"]="Muzzle Flash"
    ["4541008D"]="MVP 06: NCAA Baseball"
    ["4541002D"]="MVP Baseball 2003"
    ["45410045"]="MVP Baseball 2004"
    ["45410056"]="MVP Baseball 2005"
    ["54510003"]="MX 2002 featuring Ricky Carmichael"
    ["54510010"]="MX Superfly"
    ["54510021"]="MX Unleashed"
    ["545100ED"]="MX vs. ATV Unleashed"
    ["4356000E"]="MX World Tour Featuring Jamie Little"
    ["55530011"]="Myst III: Exile"
    ["5553004A"]="Myst IV: Revelation"
    ["4D53003C"]="N.U.D.E.@ Natural Ultimate Digital Experiment"
    ["53550002"]="Nakajima Tetsuya no Othello Seminar"
    ["4E4D0007"]="Namco Museum"
    ["4E4D0016"]="Namco Museum 50th Anniversary"
    ["4D570024"]="Narc"
    ["4541008B"]="NASCAR 06: Total Team Control"
    ["454100A3"]="NASCAR 07"
    ["45410053"]="NASCAR 2005: Chase for the Cup"
    ["49470009"]="NASCAR Heat 2002"
    ["45410002"]="NASCAR Thunder 2002"
    ["4541001B"]="NASCAR Thunder 2003"
    ["45410031"]="NASCAR Thunder 2004"
    ["53450002"]="NBA 2K2"
    ["53450013"]="NBA 2K3"
    ["54540090"]="NBA 2K6"
    ["545400AE"]="NBA 2K7"
    ["4D570010"]="NBA Ballers"
    ["4D57002E"]="NBA Ballers: Phenom"
    ["4D530011"]="NBA Inside Drive 2002"
    ["4D530045"]="NBA Inside Drive 2003"
    ["4D53000B"]="NBA Inside Drive 2004"
    ["41430013"]="NBA Jam"
    ["4541007A"]="NBA Live 06"
    ["454100A1"]="NBA Live 07"
    ["45410003"]="NBA Live 2002"
    ["4541001C"]="NBA Live 2003"
    ["45410038"]="NBA Live 2004"
    ["45410050"]="NBA Live 2005"
    ["4B4E0012"]="NBA Starting Five"
    ["45410058"]="NBA Street V3"
    ["45410027"]="NBA Street Vol. 2"
    ["53450018"]="NCAA College Basketball 2K3"
    ["53450010"]="NCAA College Football 2K3"
    ["45410080"]="NCAA Football 06"
    ["454100A2"]="NCAA Football 07"
    ["454100AB"]="NCAA Football 08"
    ["4541001D"]="NCAA Football 2003"
    ["45410035"]="NCAA Football 2004"
    ["45410051"]="NCAA Football 2005"
    ["45410090"]="NCAA March Madness 06"
    ["45410044"]="NCAA March Madness 2004"
    ["45410052"]="NCAA March Madness 2005"
    ["4541009E"]="Need for Speed: Carbon"
    ["45410028"]="Need for Speed: Hot Pursuit 2"
    ["4541007B"]="Need for Speed: Most Wanted"
    ["45410047"]="Need for Speed: Underground"
    ["4541005A"]="Need for Speed: Underground 2"
    ["4A570002"]="Neighbours from Hell"
    ["54510001"]="New Legends"
    ["53450006"]="NFL 2K2"
    ["53450011"]="NFL 2K3"
    ["4D570001"]="NFL Blitz 20-02"
    ["4D57000A"]="NFL Blitz 2003"
    ["4D570014"]="NFL Blitz Pro"
    ["4D530006"]="NFL Fever 2002"
    ["4D530028"]="NFL Fever 2003"
    ["4D53004D"]="NFL Fever 2004"
    ["4541008E"]="NFL Head Coach"
    ["45410048"]="NFL Street"
    ["45410057"]="NFL Street 2"
    ["4541007C"]="NHL 06"
    ["454100A5"]="NHL 07"
    ["45410005"]="NHL 2002"
    ["4541001E"]="NHL 2003"
    ["45410030"]="NHL 2004"
    ["4541004F"]="NHL 2005"
    ["53450017"]="NHL 2K3"
    ["5454008D"]="NHL 2K6"
    ["545400AD"]="NHL 2K7"
    ["4D570003"]="NHL Hitz 20-02"
    ["4D57000B"]="NHL Hitz 20-03"
    ["4D57001A"]="NHL Hitz Pro"
    ["4D53004E"]="NHL Rivals 2004"
    ["49470028"]="Nickelodeon Party Blast"
    ["4A410002"]="NightCaster II: Equinox"
    ["4D530008"]="NightCaster: Defeat the Darkness"
    ["54430003"]="Ninja Gaiden"
    ["5443000D"]="Ninja Gaiden Black"
    ["4B4F0001"]="Nobunaga no Yabou: Ranseiki"
    ["4D490009"]="ObsCure"
    ["4D530001"]="Oddworld: Munch's Oddysee"
    ["4541006D"]="Oddworld: Stranger's Wrath"
    ["55530061"]="Open Season"
    ["434D005A"]="Operation Flashpoint: Elite"
    ["46530004"]="Otogi 2: Immortal Warriors"
    ["46530002"]="Otogi: Myth of Demons"
    ["56550010"]="Outlaw Golf"
    ["54540017"]="Outlaw Golf 2"
    ["53530006"]="Outlaw Golf: 9 More Holes of X-Mas"
    ["54540076"]="Outlaw Tennis"
    ["53530003"]="Outlaw Volleyball"
    ["53538003"]="Outlaw Volleyball: Red Hot"
    ["53450036"]="OutRun 2"
    ["53450088"]="OutRun 2006: Coast 2 Coast"
    ["41560058"]="Over the Hedge"
    ["4E4D0006"]="Pac-Man World 2"
    ["4E4D0017"]="Pac-Man World 3"
    ["44430003"]="Painkiller: Hell Wars"
    ["53450007"]="Panzer Dragoon Orta"
    ["4A570009"]="Panzer Elite Action: Fields of Glory"
    ["47560001"]="Pariah"
    ["5553004C"]="Peter Jackson's King Kong"
    ["41510001"]="Petit Copter"
    ["4D53004A"]="Phantasy Star Online Episode I & II"
    ["504C0001"]="Phantom Crash"
    ["4D530046"]="Phantom Dust"
    ["4F580002"]="Pilot Down: Behind Enemy Lines"
    ["4356000A"]="Pinball Hall of Fame"
    ["42530004"]="Pirates of the Caribbean"
    ["45410015"]="Pirates: The Legend of Black Kat"
    ["41560018"]="Pitfall: The Lost Expedition"
    ["41480002"]="Playboy: The Mansion"
    ["544B0004"]="Plus Plumb 2"
    ["4D5300D4"]="PocketBike Racer"
    ["5A440001"]="Pool Shark 2"
    ["4253000B"]="Powerdrome"
    ["56550030"]="Predator: Concrete Jungle"
    ["5553001D"]="Prince of Persia: The Sands of Time"
    ["55530058"]="Prince of Persia: The Two Thrones"
    ["5553003B"]="Prince of Persia: Warrior Within"
    ["434D0008"]="Prisoner of War"
    ["4343000B"]="Pro Cast Sports Fishing"
    ["4B4E0022"]="Pro Evolution Soccer 4"
    ["4B4E0030"]="Pro Evolution Soccer 5"
    ["41540003"]="Pro Fishing Challenge"
    ["434D0002"]="Pro Race Driver"
    ["4D530003"]="Project Gotham Racing"
    ["4D53004B"]="Project Gotham Racing 2"
    ["45530019"]="Project Snowblind"
    ["4F580004"]="ProStroke Golf: World Tour 2007"
    ["4D570016"]="Psi-Ops: The Mindgate Conspiracy"
    ["4D4A0012"]="Psychonauts"
    ["53550009"]="Psyvariar 2"
    ["4A410001"]="Pulse Racer"
    ["41440002"]="Pump It Up: Exceed"
    ["54540011"]="Pure Pinball"
    ["53450027"]="Puyo Pop: Fever"
    ["4D530015"]="Quantum Redshift"
    ["4E4D0008"]="R: Racing Evolution"
    ["4D53000F"]="RalliSport Challenge"
    ["4D530039"]="RalliSport Challenge 2"
    ["41560009"]="Rally Fusion: Race of Champions"
    ["4156003A"]="Rapala Pro Fishing"
    ["54510109"]="Ratatouille"
    ["55530002"]="Rayman 3: Hoodlum Havoc"
    ["55530003"]="Rayman Arena"
    ["4D4A0011"]="Raze's Hell"
    ["49410001"]="Real World Golf"
    ["5454001A"]="Red Dead Revolver"
    ["54510005"]="Red Faction II"
    ["56550027"]="Red Ninja: End of Honor"
    ["4D57000F"]="RedCard 20-03"
    ["424D0002"]="Reign of Fire"
    ["5345001D"]="Rent-A-Hero No. 1"
    ["534300FF"]="Reservoir Dogs"
    ["41560010"]="Return to Castle Wolfenstein: Tides of War"
    ["53430005"]="Richard Burns Rally"
    ["434D0057"]="Ricky Ponting International Cricket 2005"
    ["49500006"]="RLH: Run Like Hell"
    ["4D570018"]="RoadKill"
    ["4343000C"]="Robin Hood: Defender of the Crown"
    ["54530005"]="RoboCop"
    ["42570001"]="Robot Wars: Extreme Destruction"
    ["544D0002"]="Robotech: Battlecry"
    ["5454001B"]="Robotech: Invasion"
    ["56550037"]="Robots"
    ["55530014"]="Rocky"
    ["55530034"]="Rocky: Legends"
    ["4B420004"]="Rogue Ops"
    ["5343000E"]="Rogue Trooper"
    ["4947002E"]="RollerCoaster Tycoon"
    ["53430007"]="Rolling"
    ["4A410006"]="Room Zoom"
    ["45410087"]="Rugby 06"
    ["45410061"]="Rugby 2005"
    ["48500005"]="Rugby Challenge 2006"
    ["48450001"]="Rugby League"
    ["48450005"]="Rugby League 2"
    ["5340000"]="Samurai Shodown V"
    ["4B4F0006"]="Samurai Warriors"
    ["5454007A"]="Scaler"
    ["4C530002"]="SCAR : Squadra Corse Alfa Romeo"
    ["5655003F"]="Scarface: The World Is Yours"
    ["5451000E"]="Scooby-Doo! Mystery Mayhem"
    ["5451001F"]="Scooby-Doo! Night of 100 Frights"
    ["545100F7"]="Scooby-Doo! Unmasked"
    ["56550017"]="SeaBlade"
    ["41560050"]="SeaWorld: Shamu's Deep Sea Adventures"
    ["434D0047"]="Second Sight"
    ["4C410006"]="Secret Weapons Over Normandy"
    ["53450003"]="Sega GT 2002"
    ["53450021"]="Sega GT Online"
    ["53450014"]="Sega Soccer Slam"
    ["434D005B"]="Sensible Soccer 2006"
    ["41510003"]="Sentou Yousei Yukikaze: Yousei no Mau Sora"
    ["54540004"]="Serious Sam"
    ["5454000D"]="Serious Sam II"
    ["4B4E000E"]="Shadow of Memories"
    ["49470025"]="Shadow Ops: Red Mercury"
    ["53450086"]="Shadow the Hedgehog"
    ["41560038"]="Shark Tale"
    ["54540083"]="Shattered Union"
    ["45530013"]="Shellshock: Nam '67"
    ["4D530032"]="Shenmue II"
    ["4D500002"]="Shikigami no Shiro"
    ["4B490001"]="Shikigami no Shiro Evolution"
    ["4B490002"]="Shikigami no Shiro II"
    ["41540002"]="Shin Megami Tensei: Nine"
    ["45460001"]="Shinchou Mahjong (Nobunaga Mahjong)"
    ["4143001D"]="Showdown: Legends of Wrestling"
    ["544D0001"]="Shrek"
    ["41560037"]="Shrek 2"
    ["544D0004"]="Shrek Super Party"
    ["41560048"]="Shrek SuperSlam"
    ["5454008F"]="Sid Meier's Pirates!"
    ["4B4E0004"]="Silent Hill 2"
    ["4B4E001F"]="Silent Hill 4: The Room"
    ["4B4E001A"]="Silent Scope Complete"
    ["4A570005"]="Ski Racing 2005"
    ["4A57000A"]="Ski Racing 2006"
    ["49470011"]="Slam Tennis"
    ["4E4D0001"]="Smashing Drive"
    ["4D5300D3"]="Sneak King"
    ["4D530023"]="Sneakers"
    ["4D49000D"]="Sniper Elite"
    ["4156001B"]="Soldier of Fortune II: Double Helix"
    ["5345002B"]="Sonic Heroes"
    ["5345003C"]="Sonic Mega Collection Plus"
    ["53450087"]="Sonic Riders"
    ["4E4D0003"]="Soulcalibur II"
    ["5345008B"]="Spartan: Total Warrior"
    ["4E4D000C"]="Spawn: Armageddon"
    ["4143000B"]="Speed Kings"
    ["54510023"]="Sphinx and the Cursed Mummy"
    ["41560006"]="Spider-Man"
    ["4156002B"]="Spider-Man 2"
    ["53450029"]="Spikeout: Battle Street"
    ["4947001B"]="Splashdown"
    ["54540093"]="Splat Magazine Renegade Paintball"
    ["5451001A"]="SpongeBob SquarePants: Battle for Bikini Bottom"
    ["545100FA"]="SpongeBob SquarePants: Lights, Camera, Pants!"
    ["4D57001B"]="Spy Hunter 2"
    ["4D570037"]="Spy Hunter: Nowhere to Run"
    ["5454007C"]="Spy vs. Spy"
    ["4D570004"]="SpyHunter"
    ["56550034"]="Spyro: A Hero's Tail"
    ["4541003C"]="SSX 3"
    ["45410082"]="SSX On Tour"
    ["45410004"]="SSX Tricky"
    ["4D4D0001"]="Stacked with Daniel Negreanu"
    ["4D440004"]="Stake: Fortune Fighters"
    ["544D0010"]="Star Trek: Shattered Universe"
    ["4C410009"]="Star Wars Jedi Knight II: Jedi Outcast"
    ["4C41000B"]="Star Wars Jedi Knight: Jedi Academy"
    ["4C410014"]="Star Wars Knights of the Old Republic II: The Sith Lords"
    ["4C410011"]="Star Wars: Battlefront"
    ["4C41001A"]="Star Wars: Battlefront II"
    ["4C410017"]="Star Wars: Episode III – Revenge of the Sith"
    ["4C410005"]="Star Wars: Jedi Starfighter"
    ["4C410003"]="Star Wars: Knights of the Old Republic"
    ["4C410001"]="Star Wars: Obi-Wan"
    ["4C410013"]="Star Wars: Republic Commando"
    ["4C410002"]="Star Wars: Starfighter Special Edition"
    ["4C410004"]="Star Wars: The Clone Wars"
    ["454D0005"]="Starsky & Hutch"
    ["54540006"]="State of Emergency"
    ["43430002"]="Steel Battalion"
    ["43430009"]="Steel Battalion: Line of Contact"
    ["4D49000B"]="Still Life"
    ["48500001"]="Stolen"
    ["4343000F"]="Street Fighter Anniversary Collection"
    ["41560003"]="Street Hoops"
    ["4E4D0013"]="Street Racing Syndicate"
    ["43560008"]="Strike Force Bowling"
    ["41590002"]="Stubbs the Zombie in Rebel Without a Pulse"
    ["4D53000A"]="Sudeki"
    ["4A410004"]="Super Bubble Pop"
    ["53450038"]="Super Monkey Ball Deluxe"
    ["454100A0"]="Superman Returns"
    ["49470016"]="Superman: The Man of Steel"
    ["5340"]="SVC Chaos: SNK vs. Capcom"
    ["56560025"]="SWAT: Global Strike Team"
    ["41430010"]="SX Superstar"
    ["4D490006"]="Syberia"
    ["4D490008"]="Syberia II"
    ["454D001C"]="Taito Legends"
    ["454D0022"]="Taito Legends 2"
    ["5451008B"]="Tak 2: The Staff of Dreams"
    ["545100F4"]="Tak: The Great Juju Challenge"
    ["53550005"]="Takahashi Junko no Mahjong Seminar"
    ["4D530014"]="Tao Feng: Fist of the Lotus"
    ["4947000D"]="Taz: Wanted"
    ["5443000E"]="Tecmo Classic Arcade"
    ["4D4A0013"]="Teen Titans"
    ["4B4E001B"]="Teenage Mutant Ninja Turtles"
    ["4B4E0023"]="Teenage Mutant Ninja Turtles 2: Battle Nexus"
    ["4B4E002A"]="Teenage Mutant Ninja Turtles 3: Mutant Nightmare"
    ["4B4E0020"]="Teenage Mutant Ninja Turtles: Mutant Melee"
    ["46530005"]="Tenchu 3: Kaiki No Shou"
    ["41560026"]="Tenchu: Return from Darkness"
    ["41500001"]="Tenerezza"
    ["4D53002F"]="Tenku Freestyle Snowboarding"
    ["4D490003"]="Tennis Masters Series 2003"
    ["4947003B"]="Terminator 3: Rise of the Machines"
    ["4947003E"]="Terminator 3: The Redemption"
    ["49470007"]="Test Drive"
    ["49470075"]="Test Drive: Eve of Destruction"
    ["49470001"]="Test Drive: Off-Road Wide Open"
    ["5451000A"]="Tetris Worlds"
    ["5451001C"]="Tetris Worlds (Online Edition)"
    ["49580001"]="The Bard's Tale"
    ["4B410002"]="The Baseball 2002: Battle Ball Park Sengen"
    ["43560011"]="The Bible Game"
    ["42560003"]="The Chronicles of Narnia: The Lion, the Witch and the Wardrobe"
    ["56550026"]="The Chronicles of Riddick: Escape from Butcher Bay"
    ["545400AB"]="The Da Vinci Code"
    ["5553003A"]="The Dukes of Hazzard: Return of the General Lee"
    ["42530001"]="The Elder Scrolls III: Morrowind"
    ["42530005"]="The Elder Scrolls III: Morrowind G.O.T.Y"
    ["54510020"]="The Fairly OddParents: Breakin' Da Rules"
    ["4541007D"]="The Godfather: The Game"
    ["53430003"]="The Great Escape"
    ["5454007B"]="The Guy Game"
    ["544D000D"]="The Haunted Mansion"
    ["56550023"]="The Hobbit"
    ["53450008"]="The House of the Dead III"
    ["4156005B"]="The Hustle: Detroit Streets"
    ["56550039"]="The Incredible Hulk: Ultimate Destruction"
    ["54510028"]="The Incredibles"
    ["545100F6"]="The Incredibles: Rise of the Underminer"
    ["4553000E"]="The Italian Job"
    ["534000000"]="The King of Fighters 2002"
    ["534000"]="The King of Fighters 2003"
    ["534E000A"]="The King of Fighters Neowave"
    ["5340000000"]="The King of Fighters: Maximum Impact: Maniax"
    ["5655004A"]="The Legend of Spyro: A New Beginning"
    ["56550004"]="The Lord of the Rings: The Fellowship of the Ring"
    ["4541003E"]="The Lord of the Rings: The Return of the King"
    ["4541005F"]="The Lord of the Rings: The Third Age"
    ["45410010"]="The Lord of the Rings: The Two Towers"
    ["4947007C"]="The Matrix: Path of Neo"
    ["54510018"]="The Punisher"
    ["56550015"]="The Simpsons: Hit & Run"
    ["45410013"]="The Simpsons: Road Rage"
    ["4541002F"]="The Sims"
    ["4541038B"]="The Sims 2"
    ["45410043"]="The Sims Bustin' Out"
    ["54510027"]="The SpongeBob SquarePants Movie"
    ["4D570015"]="The Suffering"
    ["4D57002C"]="The Suffering: Ties That Bind"
    ["49470026"]="The Terminator: Dawn of Fate"
    ["5655000D"]="The Thing"
    ["45410060"]="The Urbz: Sims in the City"
    ["5454009B"]="The Warriors"
    ["4D530048"]="The Wild Rings"
    ["45530004"]="Thief: Deadly Shadows"
    ["46530003"]="Thousand Land"
    ["4C410022"]="Thrillville"
    ["4541007E"]="Tiger Woods PGA Tour 06"
    ["454100A4"]="Tiger Woods PGA Tour 07"
    ["45410021"]="Tiger Woods PGA Tour 2003"
    ["4541003A"]="Tiger Woods PGA Tour 2004"
    ["45410054"]="Tiger Woods PGA Tour 2005"
    ["42560004"]="Tim Burton's The Nightmare Before Christmas: Oogie's Revenge"
    ["4553000A"]="TimeSplitters 2"
    ["45410066"]="TimeSplitters: Future Perfect"
    ["434D0002"]="Toca Race Driver"
    ["434D0011"]="TOCA Race Driver 2: The Ultimate Racing Simulator"
    ["434D0050"]="TOCA Race Driver 3"
    ["434D000E"]="Toca Race Driver Online Enabled"
    ["5345000F"]="ToeJam & Earl III: Mission to Earth"
    ["4E4B0001"]="Tom and Jerry in War of the Whiskers"
    ["55530006"]="Tom Clancy's Ghost Recon"
    ["55530005"]="Tom Clancy's Ghost Recon 2"
    ["5553004D"]="Tom Clancy's Ghost Recon 2: Summit Strike"
    ["55530054"]="Tom Clancy's Ghost Recon: Advanced Warfighter"
    ["55530007"]="Tom Clancy's Ghost Recon: Island Thunder"
    ["55530013"]="Tom Clancy's Rainbow Six 3"
    ["55530037"]="Tom Clancy's Rainbow Six 3: Black Arrow"
    ["5553005F"]="Tom Clancy's Rainbow Six: Critical Hour"
    ["55530048"]="Tom Clancy's Rainbow Six: Lockdown"
    ["5553000C"]="Tom Clancy's Splinter Cell"
    ["55530041"]="Tom Clancy's Splinter Cell: Chaos Theory"
    ["5553005E"]="Tom Clancy's Splinter Cell: Double Agent"
    ["55530019"]="Tom Clancy's Splinter Cell: Pandora Tomorrow"
    ["534300FD"]="Tomb Raider: Legend"
    ["41560049"]="Tony Hawk's American Wasteland"
    ["41560001"]="Tony Hawk's Pro Skater 2x"
    ["41560004"]="Tony Hawk's Pro Skater 3"
    ["41560017"]="Tony Hawk's Pro Skater 4"
    ["4156005E"]="Tony Hawk's Project 8"
    ["4156002D"]="Tony Hawk's Underground"
    ["4156003C"]="Tony Hawk's Underground 2"
    ["4B420007"]="Top Gear RPM Tuning"
    ["4D530035"]="Top Spin"
    ["545400A9"]="Torino 2006"
    ["55530040"]="Tork: Prehistoric Punk"
    ["45410041"]="Total Club Manager 2004"
    ["45410065"]="Total Club Manager 2005"
    ["56550013"]="Total Immersion Racing"
    ["53430010"]="Total Overdose: A Gunslinger's Tale in Mexico"
    ["4D4A0002"]="Totaled!"
    ["41540001"]="Touge R"
    ["4B4E000F"]="Tour de France"
    ["54510007"]="Toxic Grind"
    ["49470004"]="TransWorld Snowboarding"
    ["49470005"]="Transworld Surf"
    ["4B4B0001"]="Triangle Again"
    ["4B4B0002"]="Triangle Again 2"
    ["43560009"]="Trigger Man"
    ["45410009"]="Triple Play 2002"
    ["4947003D"]="Trivial Pursuit Unhinged"
    ["42560001"]="Tron 2.0 Killer App"
    ["41560045"]="True Crime: New York City"
    ["4156000E"]="True Crime: Streets of LA"
    ["41430004"]="Turok: Evolution"
    ["45410029"]="Ty the Tasmanian Tiger"
    ["45410063"]="Ty the Tasmanian Tiger 2: Bush Rescue"
    ["41560055"]="Ty the Tasmanian Tiger 3: Night of the Quinkan"
    ["45410070"]="UEFA Champions League 2004-2005"
    ["4541004A"]="UEFA Euro 2004"
    ["43560002"]="UFC: Tapout"
    ["544D000A"]="UFC: Tapout 2"
    ["57450001"]="Ultimate Beach Soccer"
    ["454D001D"]="Ultimate Pro Pinball"
    ["41560035"]="Ultimate Spider-Man"
    ["4D4A000C"]="Ultra Bust-a-Move"
    ["53550003"]="Umezawa Yukari no Igo Seminar"
    ["49470024"]="Unreal Championship"
    ["4D570021"]="Unreal Championship 2: The Liandri Conflict"
    ["4947003C"]="Unreal II: The Awakening"
    ["534300F7"]="Urban Chaos: Riot Response"
    ["4143000C"]="Urban Freestyle Soccer"
    ["49470034"]="V-Rally 3"
    ["56550029"]="Van Helsing"
    ["41430005"]="Vexx"
    ["5454000A"]="Vietcong: Purple Haze"
    ["54540016"]="Virtual Pool: Tournament Edition"
    ["4D530084"]="Volvo: Drive For Life"
    ["4D53005F"]="Voodoo Vince"
    ["4156000D"]="Wakeboarding Unleashed"
    ["424D0003"]="Wallace & Gromit in Project Zoo"
    ["4B4E0034"]="Wallace & Gromit: The Curse of the Were-Rabbit"
    ["4756000A"]="Warpath"
    ["4D530027"]="Whacked!"
    ["45530011"]="Whiplash"
    ["4B4E0001"]="Whiteout"
    ["4B4F0008"]="WinBack 2: Project Poseidon"
    ["54540018"]="Wings of War"
    ["43430014"]="Without Warning"
    ["4356000D"]="World Championship Poker"
    ["43560010"]="World Championship Poker 2: Featuring Howard Lederer"
    ["4A410007"]="World Championship Pool 2004"
    ["4143001F"]="World Championship Rugby"
    ["434D000D"]="World Championship Snooker 2003"
    ["434D002A"]="World Championship Snooker 2004"
    ["54540087"]="World Poker Tour"
    ["544D0005"]="World Racing"
    ["544D0012"]="World Racing 2"
    ["5345000E"]="World Series Baseball"
    ["5345001A"]="World Series Baseball 2K3"
    ["41560054"]="World Series of Poker"
    ["53450081"]="World Snooker Championship 2005"
    ["4B4E0027"]="World Soccer Winning Eleven 8 International"
    ["4B4E002F"]="World Soccer Winning Eleven 9"
    ["4756000B"]="World War II Combat: Iwo Jima"
    ["47560009"]="World War II Combat: Road to Berlin"
    ["5345002A"]="Worms 3D"
    ["4D4A0017"]="Worms 4: Mayhem"
    ["53450035"]="Worms Forts: Under Siege"
    ["4C41000F"]="Wrath Unleashed"
    ["4156000A"]="Wreckless: The Yakuza Missions"
    ["4B4E0010"]="WTA Tour Tennis"
    ["5451000D"]="WWE Raw 2"
    ["54510024"]="WWE WrestleMania 21"
    ["54510002"]="WWF RAW"
    ["4156001E"]="X-Men Legends"
    ["41560047"]="X-Men Legends II: Rise of Apocalypse"
    ["41560007"]="X-Men: Next Dimension"
    ["41560046"]="X-Men: The Official Game"
    ["41560008"]="X2: Wolverine's Revenge"
    ["4D5300C8"]="Xbox Live Arcade"
    ["4D53005A"]="Xbox Music Mixer"
    ["41430014"]="XGRA: Extreme-G Racing Association"
    ["4B4E0038"]="Xiaolin Showdown"
    ["55530009"]="XIII"
    ["50430001"]="Xyanide"
    ["4B420006"]="Yager"
    ["4A570004"]="Yetisports Arctic Adventures"
    ["53550004"]="Yonenaga Kunio no Shougi Seminar"
    ["52440001"]="Yourself!Fitness"
    ["4B4E001E"]="Yu-Gi-Oh! The Dawn of Destiny"
    ["47450001"]="Zan Kabuki"
    ["49470012"]="Zapper: One Wicked Cricket"
    ["5454008C"]="Zathura"
    ["53540001"]="ZillerNet"
  )
  local CN FATXCHARS
  # Get game's Title Name based on its Title ID
  if [[ -v 'TITLENAME[$1]' ]]; then
    TITLE="${TITLENAME[$1]}"
  else
    # Use redump's filename as xiso's filename.
    TITLE="${2##*/}"
    TITLE="${TITLE%%(*}"
  fi
  # FATX only support characters below (include space):
  # ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!#$%&'()-.@[]^_`{}~
  FATXCHARS='[^]0-9a-zA-Z!#$%&'\''().@^_`{}~\ [-]'
  # Replace colon with [:space:]dash.
  CN="${TITLE//:/ -}"
  # Is game's title contains illegal caharacters?
  if [[ $CN =~ $FATXCHARS ]]; then
    print_w 'Removing unsupported character at:'
    for (( i = 0; i < ${#CN}; i++ )) do
      c=${CN:$i:1}
      if [[ $c =~ $FATXCHARS ]]; then
        print_w "- index $i: $c"
        # Remove unsupported character.
        CN="${CN:0:$i}${CN:$((i+1)):${#CN}}"
      fi
    done
  fi
  # Remove trailing whitespace.
  shopt -s extglob
  CN="${CN%%+([[:space:]])}"

  # FATX only support 42 characters for filename (that include spaces).
  # [0]: 42 chars for dir, [1]: 38 chars for single xiso, [2]: 36 chars for splitted xisos.
  TITLE=( "${CN:0:41}" "${CN:0:37}" "${CN:0:35}" )
}

get_xbe() {
  local BASE CERT DATALOC RTID XBEBIN
  XBEBIN="${TMPDIR}/default.xbe"
  # Extract default.xbe
  DATALOC=$("$HERE/bin/xdvdfs" info "$1" /default.xbe | grep -oP '(?<=Sector ).*?(?= bytes)')
  if [[ $XTYPE == 'redump' ]]; then
    # Redump image has a video partition as big as 387 MB or 405798912 Bytes (1024*1024*387).
    dd if="$XISOIN" of="$XBEBIN" skip="$(((${DATALOC%% *}*2048)+405798912))" count="${DATALOC##*\(}" iflag=skip_bytes,count_bytes status=none
  elif [[ $XTYPE == 'xiso' ]]; then
    dd if="$XISOIN" of="$XBEBIN" skip="$((${DATALOC%% *}*2048))" count="${DATALOC##*\(}" iflag=skip_bytes,count_bytes status=none
  fi

  # Get base address.
  BASE="$(xxd -e -l 4 -s 0x104 "$XBEBIN")"
  BASE="0x${BASE:10:8}"
  # Get certificate address.
  CERT="$(xxd -e -l 4 -s 0x118 "$XBEBIN")"
  CERT="0x${CERT:10:8}"
  # Reverse Title ID.
  RTID="$(xxd -e -u -l 8 -s "$(((CERT-BASE)+8))" "$XBEBIN")"
  RTID="${RTID:10:8}"
  XBE=( "$XBEBIN" "$BASE" "$CERT" "$RTID" )
}

install_artworks() {
  local TID ARTDIR=${1%%.*}
  ARTDIR=${ARTDIR##*/}
  7z x -bso0 "$1" -o"$TMPDIR"
  mapfile -t COVER < <(find "$TMPDIR/$ARTDIR" -size +1k -type f -name '_resources.zip')

  for ((NUM=${#COVER[@]},i=0; i<NUM;i++)); do
    if [[ -f ${COVER[i]%/*}/detials.txt ]]; then
      TID=$(<"${COVER[i]%/*}/detials.txt")
      # Remove N/A string if title doesn't have an ID.
      TID="${TID/N\/A/}"
      TID="${TID/|*\\/_}"
      # Remove carriage return.
      TID="${TID//$'\r'/}"
    else
      TID="$i"
    fi
    7z e -bso0 "${COVER[i]}" -o"$TMPDIR" '_resources/artwork/poster.jpg' -so > "$TMPDIR/${TID}.jpg"
  done
  7z a -bso0 "$ARTWORKS" "${TMPDIR}/*.jpg"
  rm -r "$TMPDIR"
  print_g 'Artworks has been installed.'
}

# Patch attacher with game's default.xbe properties.
patch_attach() {
  local ATTACHER SHIFT XTITLE XBEPATCH XBETITLE
  ATTACHER="${TMPDIR}/default.xbe"
  XBEPATCH="${ATTACHER}.hexpatch"
  # Adjust offset from game's default/game.xbe to attach.xbe's offset.
  SHIFT=$((0x00010178-XBE[2]))
  print 'Patching attacher.'
  # Create certificate patch.
  xxd -c1 -l 464 -s $((XBE[2]-XBE[1])) -o "$SHIFT" "$ATTACHER" > "$XBEPATCH"
  # Create certificate version patch.
  xxd -c1 -l 4 -s $(((XBE[2]-XBE[1])+172)) -o "$SHIFT" "$ATTACHER" >> "$XBEPATCH"
  cp "$HERE/bin/attach.xbe" "$1/default.xbe"
  # Patching the attacher.
  xxd -c1 -r "$XBEPATCH" "$1/default.xbe"
  # Create xbe title patch.
  XTITLE="$(printf '%s' "${TITLE[0]/ -/\:}" | xxd -c80 -p)"
  for i in {0..80..2}; do
    # Null terminated/zero padding string.
    XBETITLE="${XBETITLE:-}${XTITLE:i:2}00"
  done
  printf '%s' "${XBETITLE:0:160}" | xxd -p -r | xxd -c1 -o 0x184 > "$XBEPATCH"
  xxd -c1 -r "$XBEPATCH" "$1/default.xbe"
}

print() { printf '\r:: %s                                              ' "$@" ;}

# Print green text,
print_g() { printf '\e[32m:: %s\n\e[m' "$@" ;}

# Print brown text.
print_w() { printf '\e[33m:: %s\n\e[m' "$@" ;}

print_usage() {
  printf '%s\n' "
  ${0##*/} is a Bash script to convert ogxbox redump archive into xdvdfs (xiso).

  Usage: ${0##*/} OPTION

  OPTION:
    -a    Install artworks (game cover) from Rocky5's Xbox Artwork Installer.
    -b    Create xiso folder to be booted from disk.
          Need either Cerbios, driveimageutils, xiso patched M8+ BIOS, or LithiumX
          dashboard to launch the folder.
    -D    Delete the input file after processing.
    -d    Use dd instead of xdvdfs.
          This will only remove the redump's video partition, so the output
          will be quite big. Mostly around ~7 GB.
    -h    Print this help text and exit.
    -i    Input file or directory (default to $HOME).
          If input is a directory, files inside it will be batch processed.
    -j    Join splitted xisos.
    -n    Do not split Xiso.
          Script is default to no splitting, but when -b is used it will always
          splitting the xiso if its size is bigger than 4 GB.
          With this option, xiso wont be splitted even when -b is used.
    -o    Output directory (default to $HOME).
    -p    Password to extract encrypted archive.
          Script will exit on wrong password.
          If the archives protected with different passwords, it's better to not
          use this option and input password manually when asked.
    -s    Always split output xiso into two equal size.
    -u    Update attach.xbe, thumbnail, filename, and directory name.
    -v    Print version information and exit.

  Example:
    - Install artwork.
      ${0##*/} -a -i 'Xbox Artwork Installer.zip'

    - Convert CoolGame.iso and save it into /tmp/xiso directory.
      ${0##*/} -i $HOME/CoolGame.iso -o /tmp/xiso

    - Convert game isos in Redump directory and save it into /tmp/xiso.
      ${0##*/} -i $HOME/Redump -o /tmp/xiso

    - Convert CoolGame.iso to bootable from disk format.
      ${0##*/} -bi $HOME/CoolGame.iso

    - Convert CoolGame.iso and split the output into two equal size ISOs.
      ${0##*/} -si $HOME/CoolGame.iso

    - Provide password for password protected archive.
      ${0##*/} -p secretpassword -bi $HOME/CoolGame.7z
"
  exit
}

# MAIN -------------------------------------------------------------------------

# Cleanup after an unexpected event.
trap 'rm -r "$TMPDIR"; exit' SIGINT ERR

# If this script run without argument.
[[ ${#@} -eq 0 ]] && print_usage

while getopts ":abDdhi:jno:p:suv" opt; do
  case $opt in
    a)
      INSTART=true
    ;;
    b)
      ATTACH=true
    ;;
    D)
      REMIN=true
    ;;
    d)
      EXISO="$(command -v dd)"
    ;;
    h)
      print_usage
    ;;
    i)
      INPUT="$OPTARG"
    ;;
    j)
      JOIN=true
    ;;
    n)
      SPLIT=$((SPLIT+1))
    ;;
    o)
      OUTPUT="$OPTARG"
    ;;
    p)
      PASS=true
      PASSWORD="$OPTARG"
    ;;
    s)
      SPLIT=$((SPLIT+2))
    ;;
    u)
      UPDATE=true
    ;;
    v)
      echo ':: redump2x v1.3 (2023.11.18) - written by si_kabayan'
      exit
    ;;
    \?)
      print_w "Wrong option: -$OPTARG" >&2
      exit 1
    ;;
    :)
      print_w "Option -$OPTARG need an argument." >&2
      exit 1
    ;;
  esac
done

if [[ ! -w $OUTPUT ]]; then
  print_w 'Output directory is not writeable.'
  exit
fi

if ${INSTART:-false} && [[ -f $INPUT ]]; then
  install_artworks "$INPUT"
  exit
fi

if [[ -d $INPUT ]]; then
  mapfile -t XISO < <(find "$INPUT" -maxdepth 2 -type f \( -name "*.iso" -o -name "*.7z" -o -name "*.zip" -o -name "*.rar" \) 2>/dev/null)
  # Remove the second splitted xiso from array.
  XISOS="${#XISO[@]}"
  for (( n = 0; n < XISOS; n++ )) do
    if [[ ${XISO[n]:(-6):2} == .1 ]] && [[ -f ${XISO[n]:0:(-6)}.0.iso ]]; then
      unset "XISO[n]"
    fi
  done

  # Rebuild array to remove gaps created by unset.
  XISO=("${XISO[@]}")

  if [[ ${#XISO[@]} -eq 0 ]]; then
    print_w "No iso found in $INPUT."
    exit
  fi
elif [[ -f $INPUT ]]; then
  XISO=( "$INPUT" )
else
  print_w "${INPUT}: No such file or directory."
  rmdir "$TMPDIR"
  exit
fi

for (( n = 0; n < ${#XISO[@]}; n++ )) do
  XISOIN="${XISO[n]}"

  if ${JOIN:-false}; then
    OUTPUT="${XISOIN:0:(-6)}"
    if [[ ${XISO[n]:(-6)} == '.0.iso' ]] && [[ -f ${OUTPUT}.1.iso ]]; then
      printf '\e[32m\r:: %s\n\e[m' "Concatenating ${OUTPUT}*.iso"
      cat "${OUTPUT}".{0..1}.iso > "${OUTPUT}.iso"
      rm "${OUTPUT}".{0..1}.iso
    fi
    continue
  fi

  ! $UPDATE && ! ${JOIN:-false} && print_g "Processing ${XISOIN}"

  # XSPLIT is to make sure nosplit works even when -b is invoked.
  [[ $SPLIT -gt 1 ]] && XSPLIT=true || XSPLIT=false

  # Will waiting for password here if archive has encrypted headers or files.
  # Won't fix. Because:
  # 1. Most redump is archived in unencrypted zip
  # 2. Will make script more complicated
  # Solution:
  # 1. Create a folder spceial for redump input. Don't mix with another files.
  # 2. Use -p to supply a password for encrypted archive
  if ! $UPDATE && [[ "${XISOIN:(-4)}" != '.iso' ]]; then
    mapfile -t ARCHISO < <(7z l -slt "${XISO[n]}" | grep -oP '(?<=Path = ).*?(?=\.iso).iso')
    if [[ ${#ARCHISO[@]} -eq 1 ]]; then
      XISOIN="$TMPDIR/${ARCHISO[0]}"
    else
      if [[ ${#ARCHISO[@]} -eq 0 ]] || [[ ${ARCHISO[0]:(-4)} != '.iso' ]]; then
        print_w "No iso found inside ${XISO[n]##*/}."
      elif [[ ${#ARCHISO[@]} -gt 1 ]]; then
        print_w "Multiple iso found inside ${XISO[n]##*/}."
      fi
      continue
    fi
    $ATTACH && OUTDIR="$TMPDIR" || OUTDIR="$OUTPUT"
    # Is the archive encrypted?
    if [[ $(7z l -slt "${XISO[n]}" | grep -oP '(?<=Encrypted = ).*?(?=$)') = '+' ]]; then
      if ${PASS:-false}; then
        7z x -bso0 -p"$PASSWORD" -o"$OUTDIR" "${XISO[n]}"
      else
        print_w 'Enter password:'
        7z x -bso0 -o"$OUTDIR" "${XISO[n]}"
      fi
    else
      7z x -bso0 -o"$OUTDIR" "${XISO[n]}"
    fi
    $ATTACH || continue
  fi

  # Xiso contains MICROSOFT*XBOX*MEDIA string in it.
  if [[ "$(xxd -p -c20 -l 0x14 -s 0x18310000 "$XISOIN")" = '4d4943524f534f46542a58424f582a4d45444941' ]]; then
    XTYPE='redump'
  elif [[ "$(xxd -p -c20 -l 0x14 -s 0x10000 "$XISOIN")" = '4d4943524f534f46542a58424f582a4d45444941' ]]; then
    XTYPE='xiso'
  else
    XTYPE='none'
		print_w "${XISOIN}: This does not appear to be a valid xbox iso image."
		continue
  fi

  get_xbe "$XISOIN"
  get_title "${XBE[3]}" "$XISOIN"

  if $UPDATE; then
    OUTPUT="${XISOIN%/*}"
    printf '\e[32m\r:: %s\n\e[m' "Updating ${OUTPUT}"
    patch_attach "$OUTPUT"
    add_artworks "${XBE[3]}" "$OUTPUT"
    if [[ ${XISOIN:(-6):2} == .0 ]] && [[ -f ${XISOIN:0:(-6)}.1.iso ]]; then
      # Rename splitted xisos.
      [[ -f "$OUTPUT/${TITLE[2]}.0.iso" ]] || mv "$XISOIN" "$OUTPUT/${TITLE[2]}.0.iso"
      [[ -f "$OUTPUT/${TITLE[2]}.1.iso" ]] || mv "${XISOIN:0:(-6)}.1.iso" "$OUTPUT/${TITLE[2]}.1.iso"
    else
      [[ -f "$OUTPUT/${TITLE[1]}.iso" ]] || mv "$XISOIN" "$OUTPUT/${TITLE[1]}.iso"
    fi
    # Rename xiso's directory.
    [[ -d "${OUTPUT%/*}/${TITLE[0]}" ]] || mv "$OUTPUT" "${OUTPUT%/*}/${TITLE[0]}"
    if [[ $((n+1)) -eq ${#XISO[@]} ]]; then
      printf '\r:: %s\n' 'Done.                                                '
    fi
    continue
  fi

  XISOUT="$OUTPUT/${TITLE[0]}/${TITLE[1]}.iso"
  mkdir -p "${XISOUT%/*}"

  if [[ $XTYPE != 'none' ]]; then
    if [[ ${EXISO##*/} = 'xdvdfs' ]]; then
      print 'Repacking redump.'
      "$EXISO" pack "$XISOIN" "$XISOUT" 1>"$TMPDIR"/repack.log
    elif [[ ${EXISO##*/} = 'dd' ]]; then
      print 'Removing video partition.'
      "$EXISO" if="$XISOIN" of="$XISOUT" skip=387 bs=1M status=none
    fi
  fi

  # Remove input?
  ${REMIN:-false} && rm -r "${XISO[n]}"

  if [[ $SPLIT -eq 0 ]] && $ATTACH && [[ $(stat -c%s "$XISOUT") -gt 4294965248 ]]; then
    XSPLIT=true
  fi

  if $XSPLIT; then
    print 'Splitting xiso.'
    split -a 1 --additional-suffix=".iso" -dn 2 "$XISOUT" "${XISOUT%/*}/${TITLE[2]}."
    rm "$XISOUT"
  fi

  if $ATTACH; then
    patch_attach "${XISOUT%/*}"
    add_artworks "${XBE[3]}" "${XISOUT%/*}"
  fi

  # List output directory.
  printf '\r:: %s                                                 \n' "Done: ${XISOUT%/*}"
  XF=( -name "${TITLE[1]}.iso" )
  if $ATTACH; then
    XF=()
  elif $XSPLIT; then
    XF=( -name "${TITLE[1]:0:35}.?.iso" )
  fi
  find "${XISOUT%/*}" -maxdepth 1 -type f "${XF[@]}" -printf '\t └─ %s - %P\n' | numfmt --field=2 --padding=+4 --to=si

  rm "$TMPDIR"/*.iso &>/dev/null || continue
done

rm -r "$TMPDIR"
